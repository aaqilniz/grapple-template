apiVersion: skaffold/v4beta9
kind: Config
metadata:
  name: "{{ .APP }}"
build:
  artifacts:
    # - image: "app-test"
    #   docker:
    #     dockerfile: Dockerfile.test
    - image: "app"
      docker:
        dockerfile: Dockerfile
      # hooks:
      #   # before:
      #   #   - command: ["sh", "-c", "./hook.sh"]
      #   #     os: [darwin, linux]
      #   after:
      #     - command: ["sh", "-c", "./publish.sh"]
      #       os: [darwin, linux]
  tagPolicy:
    dateTime: {}
deploy:
  statusCheckDeadlineSeconds: 1200
  helm:
    releases:
      - name: "{{ .APP }}"
        chartPath: chart
        valuesFiles:
          - chart/values.yaml
        version: 0.1.0
        namespace: "{{ .APP }}-dev{{ .NAMESPACE }}"
        createNamespace: true
        packaged: 
          version: 0.1.0
          appVersion: 0.1.0
portForward:
  - resourceType: service
    resourceName: "{{ .APP }}"
    port: 80
    # localPort: 8080
    namespace: "{{ .APP }}-dev{{ .NAMESPACE }}"
  # - resourceType: service
  #   resourceName: api
  #   port: 80
  #   localPort: 9999
test:
  - image: busybox
    custom:
      - command: ./test/*.sh
        timeoutSeconds: 1200
profiles:
  - name: minikube
    activation:
      - command: dev
        kubeContext: minikube
      - command: delete
        kubeContext: minikube
      - command: build
        kubeContext: minikube
    patches:
    - op: add
      path: /deploy/helm/releases/0/valuesFiles/1
      value: "chart/values-minikube.yaml"
  - name: dev
    activation:
      - command: dev
      - command: delete
      - command: build
    patches:
    - op: add
      path: /deploy/helm/releases/0/valuesFiles/1
      value: "chart/values-dev.yaml"
  - name: nop
    activation:
      - env: ENV=nop
    patches:
    - op: replace
      path: /deploy/helm/releases/0/namespace
      value: "{{ .APP }}-{{ .ENV }}"
  - name: uat
    activation:
      - env: ENV=uat
    patches:
    - op: replace
      path: /deploy/helm/releases/0/namespace
      value: "{{ .APP }}-{{ .ENV }}"
  - name: prod
    activation:
      - env: ENV=production
    patches:
    - op: replace
      path: /deploy/helm/releases/0/namespace
      value: "{{ .APP }}"
